## 1-Flow-Based Antivirus Scanning Exercise

This lab exercise provides a practical, step-by-step guide on how to configure, apply, and test a flow-based antivirus profile on a FortiGate firewall. The objective is to use the default `flow-based` inspection mode to scan FTP traffic, detect a known test virus (EICAR), block the file transfer, and verify that the event was logged correctly.

---

### Step 1: Verify the Antivirus Profile

![[Pasted image 20251112165748.png]]

- **Definition:** This step involves confirming that the `default` antivirus profile is correctly configured for flow-based inspection of the FTP protocol.
    
- **Mechanism:** You log into the FortiGate GUI and navigate to `Security Profiles > AntiVirus`. By editing the `default` profile, you verify two key settings:
    
    1. The **Feature set** is set to `Flow-based`.
        
    2. The **FTP** protocol is enabled under `Inspected Protocols`. This ensures the profile is ready to scan FTP traffic using the high-performance, flow-based method.
        

### Step 2: Apply the Profile to a Firewall Policy
![[Pasted image 20251112165837.png]]
- **Definition:** This step activates the antivirus scanning by attaching the configured profile to a relevant firewall policy.
    
- **Mechanism:** You navigate to `Policy & Objects > Firewall Policy` and edit the `Internet` policy. You confirm the policy's `Inspection mode` is also `Flow-based` (to match the profile) and then, in the `Security Profiles` section, you enable `AntiVirus` and select the `default` profile. This action tells the FortiGate to apply the rules from the `default` AV profile to all traffic that matches the `Internet` policy.
    

### Step 3: Test the Antivirus Configuration

![[Pasted image 20251112165854.png]]

![[Pasted image 20251112165903.png]]

- **Definition:** This step tests the configuration by simulating a threat: attempting to download a known, harmless test virus file.
    
- **Mechanism:** Using the FileZilla client on a test PC, you connect to an FTP server and attempt to download the `eicar.com` file. Because flow-based inspection is active, the FortiGate scans the file as it streams. It detects the EICAR signature, immediately sends a reset packet to terminate the connection, and blocks the download. The FTP client reports a connection error, confirming the block was successful.
    

### Step 4: View and Verify the Logs
![[Pasted image 20251112165916.png]]
- **Definition:** This final step confirms _why_ the download failed by reviewing the log messages generated by the FortiGate.
    
- **Mechanism:** You check two separate log sections in the GUI:
    
    1. **`Log & Report > Forward Traffic`:** This log shows the firewall policy in action, recording the FTP traffic and the "Deny" action taken.
        
    2. **`Log & Report > Security Events > AntiVirus`:** This log provides the specific security detail, confirming that the `AntiVirus` profile was triggered, the threat was identified as `eicar.com`, and the file was blocked as intended.
## 2-Proxy-Based Antivirus and SSL Inspection Exercise

This exercise demonstrates the specific behaviors and limitations of proxy-based antivirus scanning. The lab's core purpose is to show how proxy-mode's full file buffering enables it to send informative "replacement messages" and, more importantly, to illustrate why this powerful inspection is completely blind to encrypted (HTTPS) traffic unless SSL **deep inspection** is also enabled.

---

### Step 1: Switching to Proxy-Based Inspection
![[Pasted image 20251112170456.png]]
This initial step involved switching the firewall from its default "inspect-as-it-goes" (flow-based) method to a "stop-and-inspect" (proxy-based) configuration. To do this, you made a two-part change: you set the **Feature set** in the `default` Antivirus profile to `Proxy-based` and then matched this by setting the **Inspection Mode** in the `Internet` firewall policy to `Proxy-based` as well. This forces all policy traffic to be fully buffered and scanned.

### Step 2: Testing Unencrypted Traffic (HTTP)
![[Pasted image 20251112171046.png]]
This test observed the unique behavior of proxy-mode when it detects a threat in plain HTTP traffic. You downloaded the EICAR test file, and the proxy engine buffered the _entire_ file before sending it to you. Upon detecting the virus, it discarded the malicious file and sent a clean, user-friendly **replacement message** (the "Virus detected" block page) to your browser. This is a key difference from flow-mode, which would have simply reset the connection.
![[Pasted image 20251112171053.png]]
### Step 3: Demonstrating the "Save Link As" Behavior

This test reinforced how the replacement message mechanism works, even when you save a file directly to disk. Although the download _appeared_ to complete, the resulting `.txt` file on your desktop did not contain the EICAR virus. When opened, it just contained the text or HTML of the block page, showing how the proxy intercepted the file and injected its warning message directly into the file stream.

### Step 4: Exposing the "Encrypted Blind Spot" (HTTPS)

This crucial test revealed the primary weakness of all standard security profiles: encrypted traffic. You attempted to download the same EICAR file from a secure **HTTPS** site. Because the policy was only using `certificate-inspection`, it only validated the site's SSL certificate but **could not see the encrypted contents**. The antivirus engine was "blind" to the virus, allowing the malicious file to be successfully downloaded.

### Step 5: Implementing the Solution (SSL Deep Inspection)

This was the final and most important step, where you enabled the one feature capable of scanning encrypted traffic. By editing the `Internet` policy and changing the `SSL Inspection` profile to `deep-inspection`, you activated a "man-in-the-middle" (MITM) process. This allowed the FortiGate to decrypt the HTTPS traffic, send the now-plain content to the proxy engine for scanning (which _found_ the virus), and then block the threat.

### Step 6: Verifying the Logs and System Status
1-![[Pasted image 20251112171147.png]]


![[Pasted image 20251112171157.png]]
This final confirmation involved checking the firewall logs to ensure all your test attempts were recorded correctly. You verified the blocked attempts in both the `Forward Traffic` and `Security Events > AntiVirus` logs. You also checked the `Dashboard` for a high-level view and used the CLI command `execute update-av` to ensure the antivirus definitions were current.